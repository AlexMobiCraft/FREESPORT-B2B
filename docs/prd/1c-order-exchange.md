# 1C Order Exchange Module PRD

## 1. Intro Project Analysis and Context

### Existing Project Overview

**Current State:**  
Проект FREESPORT реализовал транспортный уровень интеграции с 1С (модуль `onec_exchange`):
- ✅ Аутентификация (`mode=checkauth`)
- ✅ Инициализация (`mode=init`)
- ✅ Приём файлов (`mode=file`)
- ✅ Импорт товаров, цен, остатков (`mode=import`)
- ⚠️ Заглушка для `mode=query` (возвращает пустой XML)

Отсутствует функционал **двустороннего обмена заказами**:
- Экспорт заказов покупателей в 1С
- Получение обновлённых статусов из 1С

### Business Goal

Обеспечить полный цикл обработки заказов:
1. Покупатель создаёт заказ на сайте
2. Заказ автоматически выгружается в 1С
3. Менеджер обрабатывает заказ в 1С
4. Обновлённый статус возвращается на сайт

### Available Documentation

- [Протокол обмена 1С-Bitrix (v8.1c.ru)](https://v8.1c.ru/tekhnologii/obmen-dannymi-i-integratsiya/standarty-i-formaty/protokol-obmena-s-saytom/)
- [Алгоритм Bitrix (dev.1c-bitrix.ru)](https://dev.1c-bitrix.ru/api_help/sale/algorithms/doc_from_site.php)
- [Архитектура интеграции](file:///c:/Users/1/DEV/FREESPORT/docs/architecture/1c-bitrix24-integration.md)
- [Существующий модуль onec_exchange](file:///c:/Users/1/DEV/FREESPORT/backend/apps/integrations/onec_exchange/views.py)

---

## 2. Requirements

### Functional Requirements (FR)

#### FR1: Экспорт заказов (Сайт → 1С)

| ID | Требование | Комментарий |
|----|------------|-------------|
| FR1.1 | Реализовать `mode=query` для выгрузки заказов | 1С запрашивает этот url, в ответ получает XML |
| FR1.2 | Все новые заказы передаются **одним файлом** | Стандарт обмена подразумевает пакетную передачу |
| FR1.3 | Поддержка ZIP-сжатия (`zip=yes`) | Если 1С запрашивает zip, отдавать архив |
| FR1.4 | Корневой тег XML: `<КоммерческаяИнформация>` | Стандарт CommerceML 2.10 |
| FR1.5 | Каждый заказ — тег `<Документ>` | Тип хоз. операции: `<ХозОперация>Заказ товара</ХозОперация>` |
| FR1.6 | Блок `<Контрагенты>` с **ИНН** | Поиск в 1С идет по ИНН или Наименованию (нужен ИНН если есть) |
| FR1.7 | Блок `<Товары>` с `onec_id` | Связь товаров осуществляется по ID из 1С |
| FR1.8 | Подтверждение (`mode=success`) | Помечать заказы как `sent_to_1c=true` только после этого сигнала |

#### FR2: Импорт статусов (1С → Сайт)

| ID | Требование | Комментарий |
|----|------------|-------------|
| FR2.1 | Обработка файла `orders.xml` через `mode=file` | 1С присылает файл изменений |
| FR2.2 | Парсинг заказов по `<Номер>` или `<Ид>` | Сначала находим заказ, потом парсим его реквизиты |
| FR2.3 | Обновление статуса по тегу `<ЗначениеРеквизита>` | Маппинг: `Отгружен`→`shipped`, `Доставлен`→`delivered` |
| FR2.4 | Сохранение дат оплаты/отгрузки | Берем из реквизитов "Дата оплаты", "Дата отгрузки" |

#### FR3: Модель данных Order

| ID | Требование |
|----|------------|
| FR3.1 | Добавить поле `sent_to_1c: BooleanField` |
| FR3.2 | Добавить поле `sent_to_1c_at: DateTimeField` |
| FR3.3 | Добавить поле `status_1c: CharField` для хранения оригинального статуса из 1С |

### Non-Functional Requirements (NFR)

| ID | Требование | Описание |
|----|------------|----------|
| NFR1 | Формат XML | Строго CommerceML 2.10 |
| NFR2 | Кодировка | UTF-8 или windows-1251 (по заголовку 1С), стандартно XML с UTF-8 |
| NFR3 | Безопасность | Аутентификация 1С: Обмен выполняется от имени технического пользователя `1c_user` (Basic Auth при `mode=checkauth`). Все запросы (выгрузка заказов, загрузка статусов) выполняются в рамках сессии этого пользователя. |
| NFR4 | Хранение файлов | XML файлы генерируются "на лету". Для отладки сохранять копии в `MEDIA_ROOT/1c_exchange/logs/` |

---

## 3. XML Format Specification

### Orders Export (mode=query)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<КоммерческаяИнформация ВерсияСхемы="2.10" ДатаФормирования="2026-01-29T12:00:00">
  <Документ>
    <Ид>FS-2026-00001</Ид>
    <Номер>FS-2026-00001</Номер>
    <Дата>2026-01-29</Дата>
    <Время>12:00:00</Время>
    <ХозОперация>Заказ товара</ХозОперация> <!-- Определяет категорию "Заказ с сайта" -->
    <Роль>Продавец</Роль>
    <Валюта>RUB</Валюта>
    <Курс>1</Курс>
    <Сумма>15000.00</Сумма>
    <Комментарий>Комментарий к заказу</Комментарий>
    
    <Контрагенты>
      <Контрагент>
        <Ид>customer-email-or-uuid</Ид>
        <Наименование>Иванов Иван</Наименование>
        <Роль>Покупатель</Роль>
        <ПолноеНаименование>Иванов Иван Иванович</ПолноеНаименование>
        <!-- Важно для поиска в 1С -->
        <ИНН>123456789012</ИНН> 
        <АдресРегистрации>
          <Представление>г. Москва, ул. Ленина, д. 1</Представление>
        </АдресРегистрации>
        <Контакты>
          <Контакт><Тип>Почта</Тип><Значение>email@example.com</Значение></Контакт>
          <Контакт><Тип>ТелефонРабочий</Тип><Значение>+7 999 123-45-67</Значение></Контакт>
        </Контакты>
      </Контрагент>
    </Контрагенты>
    
    <Товары>
      <Товар>
        <Ид>product-onec-id#variant-onec-id</Ид>
        <Наименование>Футбольный мяч</Наименование>
        <БазоваяЕдиница Код="796">шт</БазоваяЕдиница>
        <ЦенаЗаЕдиницу>5000.00</ЦенаЗаЕдиницу>
        <Количество>3</Количество>
        <Сумма>15000.00</Сумма>
        <ЗначенияРеквизитов>
          <ЗначениеРеквизита>
             <Наименование>ВидНоменклатуры</Наименование>
             <Значение>Товар</Значение>
          </ЗначениеРеквизита>
          <ЗначениеРеквизита>
             <Наименование>ТипНоменклатуры</Наименование>
             <Значение>Товар</Значение>
          </ЗначениеРеквизита>
        </ЗначенияРеквизитов>
      </Товар>
    </Товары>
    
    <ЗначенияРеквизитов>
      <ЗначениеРеквизита>
        <Наименование>Статус заказа</Наименование>
        <Значение>Принят</Значение>
      </ЗначениеРеквизита>
      <ЗначениеРеквизита>
        <Наименование>Способ доставки</Наименование>
        <Значение>Курьерская доставка</Значение>
      </ЗначениеРеквизита>
      <ЗначениеРеквизита>
        <Наименование>Способ оплаты</Наименование>
        <Значение>Банковская карта</Значение>
      </ЗначениеРеквизита>
      <ЗначениеРеквизита>
        <Наименование>Адрес доставки</Наименование>
        <Значение>г. Москва, ул. Ленина, д. 1</Значение>
      </ЗначениеРеквизита>
    </ЗначенияРеквизитов>
  </Документ>
</КоммерческаяИнформация>
```

### Status Update (orders.xml from 1С)

```xml
<КоммерческаяИнформация ВерсияСхемы="2.10" ДатаФормирования="2026-01-29T14:00:00">
  <Документ>
    <Ид>FS-2026-00001</Ид>
    <Номер>FS-2026-00001</Номер>
    <ЗначенияРеквизитов>
      <ЗначениеРеквизита>
        <Наименование>Статус заказа</Наименование>
        <Значение>Отгружен</Значение>
      </ЗначениеРеквизита>
      <ЗначениеРеквизита>
        <Наименование>Дата оплаты</Наименование>
        <Значение>2026-01-29</Значение>
      </ЗначениеРеквизита>
    </ЗначенияРеквизитов>
  </Документ>
</КоммерческаяИнформация>
```

---

## 4. Status Mapping

| FREESPORT | 1С (XML) | Направление |
|-----------|-----|-------------|
| `pending` | Принят | Сайт → 1С |
| `confirmed` | Принят | Сайт → 1С |
| `processing` | ОжидаетОбработки | 1С → Сайт |
| `shipped` | Отгружен | 1С → Сайт |
| `delivered` | Доставлен | 1С → Сайт |
| `cancelled` | Отменен | 1С → Сайт |

---

## 5. Work Breakdown (Stories)

### Epic: 1C Order Exchange

#### Story 1: Order Model 1C Fields
- **Goal:** Добавить поля для отслеживания синхронизации с 1С.
- **Tasks:** Миграция, добавление `sent_to_1c`, `sent_to_1c_at`, `status_1c`.
- **Verification:** Поля видны в Django Admin.

#### Story 2: Order Export Service (XML Generation)
- **Goal:** Сервис формирования XML.
- **Tasks:** `OrderExportService`: выборка заказов, генерация XML по схеме. Добавить **валидацию ИНН** (если нет - пробовать отправить без него или с заглушкой/физлицо).
- **Verification:** Unit-тест: создать заказ, вызвать сервис, проверить наличие `<ИНН>` и `<ХозОперация>`.

#### Story 3: Exchange View Logic (mode=query & success)
- **Goal:** Выгрузка по HTTP.
- **Tasks:**
  - `handle_query`: поддержка `zip=yes`, формирование ответа.
  - `handle_success`: проставление `sent_to_1c=True`.
- **Verification:** `curl` запрос возвращает валидный (возможно сжатый) XML.

#### Story 4: Import Status Service (mode=file)
- **Goal:** Обработка обратного потока.
- **Tasks:** `OrderImportService`: парсинг входящего `orders.xml`, поиск заказа по ID, обновление статуса.
- **Verification:** Загрузка XML с новым статусом меняет статус заказа в БД.

#### Story 5: Integration Testing
- **Goal:** E2E тестирование.
- **Tasks:** Написание теста полного цикла: создание → экспорт → симуляция ответа 1С → импорт.
- **Verification:** CI проходит.

---

## 6. Verification Plan

### Manual Testing

1. **Экспорт (Сайт -> 1С):**
   ```bash
   # Выгрузка (проверка zip)
   curl -u 1c_user:pass "http://localhost:8001/api/v1/integration/1c/exchange/?type=sale&mode=query&zip=no" > orders.xml
   ```
2. **Импорт (1С -> Сайт):**
   ```bash
   # Отправка файла обновлений
   curl -u 1c_user:pass -X POST \
     "http://localhost:8001/api/v1/integration/1c/exchange/?type=sale&mode=file&filename=orders.xml" \
     -H "Content-Type: application/xml" \
     -d @orders_from_1c.xml
   ```

### Automated Tests
- `tests/integration/test_order_exchange.py`

---

## 7. Risks

| Risk | Mitigation |
|------|------------|
| У пользователя нет ИНН | В 1С настроить поиск по ФИО, либо передавать "000000000000" для физлиц |
| Дублирование заказов | 1С сама отслеживает `Ид` и не создает дубли, если GUID совпадает |
| Большой размер XML | Использовать ZIP-сжатие (FR1.3) |
